# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Quant (Kçº¿å›¾ç³»ç»Ÿ) æ˜¯ä¸€ä¸ªå®Œæ•´çš„è‚¡ç¥¨Kçº¿å›¾æŸ¥è¯¢ç³»ç»Ÿï¼Œæ”¯æŒ5400åªAè‚¡çš„æ—¥Kçº¿æ•°æ®æŸ¥è¯¢å’Œå¯è§†åŒ–ã€‚

## Architecture

```
å‰ç«¯ (React + ECharts)  â†â†’  åç«¯ (FastAPI)  â†â†’  ClickHouse (é€šè¿‡SSHéš§é“)
     :5173                    :8001                192.168.50.90:8123
                                â†“
                           Redis ç¼“å­˜
```

### æ•°æ®æµ

```
ç”¨æˆ·è¯·æ±‚ â†’ FastAPI â†’ Redisç¼“å­˜æ£€æŸ¥ â†’ ClickHouseæŸ¥è¯¢ â†’ è¿”å›Kçº¿æ•°æ® â†’ EChartsæ¸²æŸ“
```

## Tech Stack

### åç«¯
- FastAPI 0.109.0
- ClickHouse Connect 0.10.0
- Redis 5.0.1
- Pandas 2.3.3

### å‰ç«¯
- React 18 + TypeScript
- Vite 7.3.1
- ECharts (Kçº¿å›¾æ¸²æŸ“)
- Ant Design (UIç»„ä»¶)
- Zustand (çŠ¶æ€ç®¡ç†)
- Axios (HTTPå®¢æˆ·ç«¯)

## Project Structure

```
Quant/
â”œâ”€â”€ kline-backend/          # åç«¯ FastAPI é¡¹ç›®
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ api/           # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ core/          # æ ¸å¿ƒé…ç½® (SSHéš§é“)
â”‚   â”‚   â”œâ”€â”€ db/            # æ•°æ®åº“å®¢æˆ·ç«¯ (ClickHouse, Redis)
â”‚   â”‚   â”œâ”€â”€ schemas/       # Pydantic æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ services/      # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â””â”€â”€ main.py        # FastAPI å…¥å£
â”‚   â””â”€â”€ requirements.txt
â”‚
â””â”€â”€ kline-frontend/        # å‰ç«¯ React é¡¹ç›®
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ api/          # API å®¢æˆ·ç«¯
    â”‚   â”œâ”€â”€ components/   # React ç»„ä»¶
    â”‚   â”œâ”€â”€ pages/        # é¡µé¢
    â”‚   â”œâ”€â”€ store/        # Zustand çŠ¶æ€ç®¡ç†
    â”‚   â””â”€â”€ types/        # TypeScript ç±»å‹
    â””â”€â”€ package.json
```

## Common Commands

### å¼€å‘ç¯å¢ƒå¯åŠ¨

```bash
# 1. å»ºç«‹ SSH éš§é“ (è¿æ¥è¿œç¨‹ ClickHouse)
ssh -N -L 18123:localhost:8123 wsl &

# 2. å¯åŠ¨åç«¯
cd kline-backend
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload

# 3. å¯åŠ¨å‰ç«¯ (æ–°ç»ˆç«¯)
cd kline-frontend
npm run dev
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

```bash
# åç«¯ (åå°è¿è¡Œ)
cd kline-backend
source venv/bin/activate
nohup uvicorn app.main:app --host 0.0.0.0 --port 8001 > server.log 2>&1 &

# å‰ç«¯æ‰“åŒ…éƒ¨ç½²
cd kline-frontend
npm run build
# å°† dist/ ç›®å½•å†…å®¹å¤åˆ¶åˆ°ç½‘å…³é™æ€ç›®å½•
cp -r dist/* ~/workspace/project/gateway/data/www/kline/
```

### æœåŠ¡çŠ¶æ€æ£€æŸ¥

```bash
# æ£€æŸ¥åç«¯
curl http://localhost:8001/health

# æ£€æŸ¥ SSH éš§é“
ps aux | grep "ssh -N -L 18123"

# æ£€æŸ¥ ClickHouse è¿æ¥
curl "http://localhost:8001/api/stocks/list?keyword=å¹³å®‰&limit=5"
```

### é‡å¯æœåŠ¡

```bash
# æ‰¾åˆ°å¹¶åœæ­¢åç«¯è¿›ç¨‹
ps aux | grep uvicorn | grep -v grep
kill <PID>

# é‡æ–°å¯åŠ¨
cd kline-backend
source venv/bin/activate
nohup uvicorn app.main:app --host 0.0.0.0 --port 8001 > server.log 2>&1 &
```

## API Endpoints

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/stocks/list` | GET | è‚¡ç¥¨åˆ—è¡¨æœç´¢ |
| `/api/kline/data` | GET | è·å–Kçº¿æ•°æ® |
| `/health` | GET | å¥åº·æ£€æŸ¥ |

### API ç¤ºä¾‹

```bash
# æœç´¢è‚¡ç¥¨
curl "http://localhost:8001/api/stocks/list?keyword=å¹³å®‰&limit=5"

# è·å–Kçº¿æ•°æ®
curl "http://localhost:8001/api/kline/data?code=000001.SZ&start_date=2024-01-01&end_date=2024-12-31&adj_type=after"
```

## Gateway Configuration

é€šè¿‡ Nginx ç½‘å…³è®¿é—®ï¼š`http://192.168.50.90/kline/`

- é™æ€æ–‡ä»¶: `/kline/` â†’ `~/gateway/data/www/kline/`
- API ä»£ç†: `/kline/api/` â†’ `http://127.0.0.1:8001/api/`
- å¥åº·æ£€æŸ¥: `/kline/health` â†’ `http://127.0.0.1:8001/health`

## Data Notes

- **æ•°æ®æº**: ClickHouse æ•°æ®åº“ (`stock.minute_kline` è¡¨)
- **è‚¡ç¥¨æ•°é‡**: 5400åª Aè‚¡
- **å¤æƒæ–¹å¼**: æ”¯æŒåå¤æƒ/å‰å¤æƒ/ä¸å¤æƒ
- **Kçº¿ç±»å‹**: å½“å‰æ”¯æŒæ—¥Kçº¿

## Completed Features

### åŸºç¡€åŠŸèƒ½
- âœ… è‚¡ç¥¨æœç´¢ (ä»£ç å’Œåç§°æ¨¡ç³Šæœç´¢)
- âœ… è‚¡ç¥¨æ•°æ®æ—¶é—´èŒƒå›´æŸ¥è¯¢
- âœ… Redis ç¼“å­˜ (æ™ºèƒ½TTLç­–ç•¥)
- âœ… SSH éš§é“è‡ªåŠ¨ç®¡ç†

### Kçº¿å›¾åŠŸèƒ½
- âœ… æ—¥Kçº¿å›¾æ˜¾ç¤º (ECharts candlestick)
- âœ… å‘¨K/æœˆK/å¹´Kçº¿æ”¯æŒ
- âœ… åˆ†é’Ÿçº§Kçº¿ (1/5/15/30/60åˆ†é’Ÿ)
- âœ… æˆäº¤é‡æŸ±çŠ¶å›¾
- âœ… æ—¶é—´èŒƒå›´æ‹–åŠ¨é€‰æ‹© (dataZoom)
- âœ… å¤æƒç±»å‹åˆ‡æ¢ (ä¸å¤æƒ/åå¤æƒ/å‰å¤æƒ)

### æŠ€æœ¯æŒ‡æ ‡
- âœ… MA å‡çº¿ (æ”¯æŒå¤šå‘¨æœŸ)
- âœ… MACD (å¿«æ…¢çº¿å’ŒæŸ±çŠ¶å›¾)
- âœ… KDJ (éšæœºæŒ‡æ ‡)
- âœ… RSI (ç›¸å¯¹å¼ºå¼±æŒ‡æ ‡)
- âœ… BOLL å¸ƒæ—å¸¦
- âœ… æŒ‡æ ‡åŠ¨æ€å åŠ å’Œå­å›¾æ˜¾ç¤º

### å¤šè‚¡å¯¹æ¯”
- âœ… æœ€å¤š5åªè‚¡ç¥¨åŒæ—¶å¯¹æ¯”
- âœ… æ¶¨è·Œå¹…å½’ä¸€åŒ–å¯¹æ¯”
- âœ… æ”¯æŒå¤šå‘¨æœŸå¯¹æ¯”

### é‡åŒ–å›æµ‹
- âœ… 5ç§å†…ç½®ç­–ç•¥ (MA/MACD/KDJ/RSI/BOLL)
- âœ… ç­–ç•¥å‚æ•°åŠ¨æ€é…ç½®
- âœ… å®Œæ•´çš„å›æµ‹å¼•æ“ (ä¹°å–ã€æ‰‹ç»­è´¹ã€å°èŠ±ç¨)
- âœ… ç»©æ•ˆæŒ‡æ ‡è®¡ç®— (æ”¶ç›Šç‡ã€å¤æ™®æ¯”ç‡ã€æœ€å¤§å›æ’¤ç­‰)
- âœ… ä¹°å…¥æŒæœ‰åŸºå‡†å¯¹æ¯”
- âœ… èµ„é‡‘æ›²çº¿å¯è§†åŒ–
- âœ… äº¤æ˜“è®°å½•æ˜ç»†
- âœ… è‡ªåŠ¨è®¾ç½®è‚¡ç¥¨å…¨å‘¨æœŸå›æµ‹

## Recent Updates (2026-02-02)

### æ–°åŠŸèƒ½å®ç°

#### 1. é‡åŒ–ç­–ç•¥å›æµ‹ç³»ç»Ÿ âœ¨
**åç«¯å®ç°**
- åˆ›å»ºå›æµ‹å¼•æ“ (`app/services/backtest/engine.py`)
  - BacktestEngine: ç®¡ç†èµ„é‡‘ã€æŒä»“ã€äº¤æ˜“æ‰§è¡Œ
  - æ”¯æŒæ‰‹ç»­è´¹è®¡ç®—ï¼ˆä¸‡ä¸‰ä½£é‡‘ + åƒä¸€å°èŠ±ç¨ï¼‰
  - æ•´ç™¾è‚¡äº¤æ˜“é™åˆ¶
  - æ¯æ—¥è´¦æˆ·çŠ¶æ€è®°å½•

- ç­–ç•¥å·¥å‚ (`app/services/backtest/strategies.py`)
  - MAå‡çº¿äº¤å‰ç­–ç•¥ï¼ˆé‡‘å‰ä¹°å…¥ã€æ­»å‰å–å‡ºï¼‰
  - MACDç­–ç•¥ï¼ˆDIF/DEAäº¤å‰ï¼‰
  - KDJç­–ç•¥ï¼ˆè¶…ä¹°è¶…å–åè½¬ï¼‰
  - RSIç­–ç•¥ï¼ˆè¶…ä¹°è¶…å–åŒºé—´çªç ´ï¼‰
  - å¸ƒæ—å¸¦ç­–ç•¥ï¼ˆè§¦åŠä¸Šä¸‹è½¨åè½¬ï¼‰
  - ç­–ç•¥å‚æ•°å®Œå…¨å¯é…ç½®

- ç»©æ•ˆæŒ‡æ ‡è®¡ç®— (`app/services/backtest/metrics.py`)
  - æ€»æ”¶ç›Šç‡ã€å¹´åŒ–æ”¶ç›Šç‡
  - æœ€å¤§å›æ’¤ã€å¤æ™®æ¯”ç‡
  - èƒœç‡ã€ç›ˆäºæ¯”
  - äº¤æ˜“ç»Ÿè®¡ï¼ˆæ€»æ¬¡æ•°ã€ç›ˆåˆ©æ¬¡æ•°ã€äºæŸæ¬¡æ•°ï¼‰

- APIç«¯ç‚¹ (`app/api/endpoints/backtest.py`)
  - `GET /api/backtest/strategies` - è·å–ç­–ç•¥åˆ—è¡¨åŠå‚æ•°å®šä¹‰
  - `POST /api/backtest/run` - æ‰§è¡Œå›æµ‹

**å‰ç«¯å®ç°**
- å›æµ‹é¡µé¢ (`src/pages/BacktestPage/index.tsx`)
  - å·¦å³åˆ†æ å¸ƒå±€ï¼ˆé…ç½® + ç»“æœï¼‰
  - è‚¡ç¥¨é€‰æ‹©ã€æ—¥æœŸèŒƒå›´ã€ç­–ç•¥é…ç½®
  - è¿è¡Œå›æµ‹ã€é‡ç½®åŠŸèƒ½
  - ç»“æœå±•ç¤ºè‡ªåŠ¨æ»šåŠ¨

- ç­–ç•¥é…ç½®é¢æ¿ (`src/components/StrategyPanel/index.tsx`)
  - ç­–ç•¥é€‰æ‹©ï¼ˆä¸‹æ‹‰æ¡†å¸¦è¯´æ˜ï¼‰
  - åŠ¨æ€å‚æ•°è¡¨å•ï¼ˆæ ¹æ®ç­–ç•¥å®šä¹‰ç”Ÿæˆï¼‰
  - åˆå§‹èµ„é‡‘ã€ä»“ä½æ¯”ä¾‹é…ç½®

- å›æµ‹ç»“æœå±•ç¤º (`src/components/BacktestResult/index.tsx`)
  - 8ä¸ªæ ¸å¿ƒç»©æ•ˆæŒ‡æ ‡å¡ç‰‡
  - èµ„é‡‘æ›²çº¿å›¾ï¼ˆEChartsåŒçº¿å¯¹æ¯”ï¼‰
  - äº¤æ˜“è®°å½•è¡¨æ ¼ï¼ˆå¯åˆ†é¡µã€ç­›é€‰ï¼‰

#### 2. ä¹°å…¥æŒæœ‰åŸºå‡†å¯¹æ¯” ğŸ“Š
- å›æµ‹æ—¶è‡ªåŠ¨è®¡ç®—ä¹°å…¥æŒæœ‰åŸºå‡†æ”¶ç›Š
- ç»©æ•ˆæŒ‡æ ‡æ–°å¢ï¼š
  - ä¹°å…¥æŒæœ‰æ”¶ç›Šç‡
  - è¶…é¢æ”¶ç›Šï¼ˆç­–ç•¥ vs åŸºå‡†ï¼‰
- èµ„é‡‘æ›²çº¿å›¾æ˜¾ç¤ºåŒçº¿å¯¹æ¯”
  - ç­–ç•¥æ”¶ç›Šï¼ˆå®çº¿+å¡«å……ï¼‰
  - ä¹°å…¥æŒæœ‰ï¼ˆè“è‰²è™šçº¿ï¼‰

#### 3. è‚¡ç¥¨æ•°æ®æ—¶é—´èŒƒå›´æŸ¥è¯¢ ğŸ“…
- æ–°å¢ API: `GET /api/stocks/date-range?code=xxx`
- StockService æ–°å¢ `get_stock_date_range()` æ–¹æ³•
- å›æµ‹é¡µé¢é€‰æ‹©è‚¡ç¥¨åè‡ªåŠ¨å¡«å……å…¨å‘¨æœŸæ—¥æœŸ

#### 4. ç”¨æˆ·ä½“éªŒä¼˜åŒ– ğŸ¨
- å›æµ‹å®Œæˆåè‡ªåŠ¨æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
- å³ä¾§ç»“æœåŒºåŸŸç‹¬ç«‹æ»šåŠ¨å®¹å™¨
- å·¦ä¾§é…ç½®é¢æ¿ä¿æŒå›ºå®šå¯è§

### Bug ä¿®å¤

#### 1. BacktestMetrics åˆå§‹åŒ–é¡ºåºé”™è¯¯
- **é—®é¢˜**: `win_rate` è®¡ç®—æ—¶ `total_trades` å°šæœªå®šä¹‰
- **ä¿®å¤**: è°ƒæ•´å±æ€§åˆå§‹åŒ–é¡ºåºï¼Œå…ˆè®¡ç®—åŸºç¡€æ•°æ®å†è®¡ç®—æ´¾ç”ŸæŒ‡æ ‡

#### 2. æ•°æ®åº“å®¢æˆ·ç«¯å¯¼å…¥é”™è¯¯
- **é—®é¢˜**: `compare.py` å’Œ `backtest.py` ä½¿ç”¨äº†ä¸å­˜åœ¨çš„ `get_clickhouse_client`
- **ä¿®å¤**: æ”¹ä¸ºå¯¼å…¥ `db_client` å…¨å±€å•ä¾‹

### å·²çŸ¥é—®é¢˜

âš ï¸ **ç­–ç•¥ä¿¡å·æœªæ‰§è¡Œé—®é¢˜**
- ç—‡çŠ¶: ç”Ÿæˆäº†äº¤æ˜“ä¿¡å·ï¼ˆå¦‚101ä¸ªï¼‰ï¼Œä½†äº¤æ˜“æ¬¡æ•°ä¸º0
- åŸå› : å¯èƒ½æ˜¯ä¿¡å·æ—¥æœŸä¸Kçº¿æ•°æ®æ—¥æœŸæ ¼å¼ä¸åŒ¹é…
- çŠ¶æ€: å·²æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼Œå¾…è¿›ä¸€æ­¥æ’æŸ¥

## Architecture Updates

### API ç«¯ç‚¹æ€»è§ˆ

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/stocks/list` | GET | è‚¡ç¥¨åˆ—è¡¨æœç´¢ |
| `/api/stocks/date-range` | GET | è·å–è‚¡ç¥¨æ•°æ®æ—¶é—´èŒƒå›´ |
| `/api/kline/data` | GET | è·å–Kçº¿æ•°æ®ï¼ˆæ”¯æŒå¤šå‘¨æœŸã€æŠ€æœ¯æŒ‡æ ‡ï¼‰ |
| `/api/kline/minute` | GET | è·å–åˆ†é’Ÿçº§Kçº¿ |
| `/api/compare/data` | GET | å¤šè‚¡å¯¹æ¯”æ•°æ® |
| `/api/backtest/strategies` | GET | è·å–ç­–ç•¥åˆ—è¡¨ |
| `/api/backtest/run` | POST | æ‰§è¡Œå›æµ‹ |
| `/health` | GET | å¥åº·æ£€æŸ¥ |

### å‰ç«¯é¡µé¢ç»“æ„

```
App (Tabs)
â”œâ”€â”€ Kçº¿å›¾ (KLinePage)
â”‚   â”œâ”€â”€ StockSelector
â”‚   â”œâ”€â”€ AdjTypeSelector
â”‚   â”œâ”€â”€ PeriodSelector
â”‚   â”œâ”€â”€ IndicatorSelector
â”‚   â””â”€â”€ KLineChart (with indicators)
â”œâ”€â”€ å¤šè‚¡å¯¹æ¯” (ComparePage)
â”‚   â”œâ”€â”€ MultiStockSelector
â”‚   â””â”€â”€ CompareChart
â””â”€â”€ ç­–ç•¥å›æµ‹ (BacktestPage)
    â”œâ”€â”€ é…ç½®é¢æ¿
    â”‚   â”œâ”€â”€ StockSelector
    â”‚   â”œâ”€â”€ DateRangePicker
    â”‚   â””â”€â”€ StrategyPanel
    â””â”€â”€ BacktestResult
        â”œâ”€â”€ ç»©æ•ˆæŒ‡æ ‡
        â”œâ”€â”€ èµ„é‡‘æ›²çº¿
        â””â”€â”€ äº¤æ˜“è®°å½•
```
